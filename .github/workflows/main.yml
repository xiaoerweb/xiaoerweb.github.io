name: Hexo Auto Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 步骤1：检出代码到 blog 子目录（关键配置）
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: recursive
          path: blog  # 指定检出到 blog 目录

      # 步骤2：验证目录结构（调试用）
      - name: Verify structure
        run: |
          echo "当前工作目录: $PWD"
          ls -lha blog/
          [ -f blog/package.json ] && echo "✅ package.json 存在" || echo "❌ package.json 缺失"

      # 步骤3：设置 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: blog/package-lock.json  # 指向子目录

      # 步骤4：安装依赖（显式指定工作目录）
      - name: Install dependencies
        run: |
          cd blog
          npm install -g hexo-cli
          npm ci --prefer-offline --audit=false

      # 步骤5：生成静态文件
      - name: Generate site
        run: |
          cd blog
          hexo clean && hexo generate

      # 步骤6：部署到 GitHub Pages
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: blog/public  # 注意路径格式
          publish_branch: main
